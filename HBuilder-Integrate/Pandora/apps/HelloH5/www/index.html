<!DOCTYPE html><html><head><meta charset=utf-8><meta http-equiv=Content-Type content="text/html; charset=utf-8"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black><meta name=format-detection content="telephone=no"><link rel=stylesheet href=static/mui.min.css><link rel=stylesheet href=static/base.css><link rel=stylesheet href=static/main.css><link rel=stylesheet href=static/iosSelect.css><script type=text/javascript src=static/mui.min.js></script><script type=text/javascript src=static/mui.back.js></script><title>收银</title><link href=./static/css/app.fcc0d49ea882a7ff53e67b24d36364ef.css rel=stylesheet></head><body><div id=app></div><script type=text/javascript src=./static/js/manifest.0c89d4c386ece694ec33.js></script><script type=text/javascript src=./static/js/app.0257d56156f19df2f9e5.js></script></body><script type=text/javascript src=static/pinyin_dict_firstletter.js></script><script type=text/javascript src=static/pinyinUtil.js></script><script type=text/javascript src=static/iosSelect.js></script><script type=text/javascript src=static/iscroll.js></script><script type=text/javascript src=static/pos.js></script><script type=text/javascript src=static/md5.min.js></script><script type=text/javascript src=static/report.js></script><script src=https://a.alipayobjects.com/g/h5-lib/alipayjsapi/3.0.6/alipayjsapi.min.js></script><script src=https://os.alipayobjects.com/rmsportal/oknmeDPmBzRhliY.js></script><script type=text/javascript>mui.init();

      // objvue.$store._actions.orderlist[0]()

        var mui_old_back = mui.back;
        var mui_is_switch = 1;
        mui.back = function(){
          var arr = location.href.split('#');
          if(arr[1].split('?')[0] == '/Home'){
            if(mui_is_switch == 1){
              mui.toast("再按一次退出应用");
              mui_is_switch = 2;
            }else{
              plus.runtime.quit();
            }
          }else{
            // mui_old_back;
            window.history.go(-1);
          }
        }

        document.addEventListener( "plusready", function(){


          var messageList = [];
          var message = document.getElementById("message");
          // 监听点击消息事件
          plus.push.addEventListener( "click", function( msg ) {
              // alert(JSON.stringify(msg));
              // 判断是从本地创建还是离线推送的消息
              switch( msg.payload ) {
                  case "LocalMSG":
                      document.addEventListener("resume", function () {
                          mui.plusReady(function(){
                            // 循环清除通知栏
                            var all_message = plus.push.getAllMessage();
                            if(all_message.length > 0){
                              for(var i = 0; i < all_message.length; i++){
                                plus.push.remove(all_message[i]);
                              }
                            }
                            // 进行跳转，使用vue-router跳转失败
                            if(msg){
                              sessionStorage.message_status = 2;
                              location.href = window.location.href.split('#')[0]+'#/Msgcenter';
                            }
                            // 需要销毁这个对象，要不然每次启动app都会跳转到指定页面
                            msg = false;
                          })
                      }, false);
                      outSet( "点击本地创建消息启动：" );
                  break;
                  default:
                      outSet( "点击离线推送消息启动：");
                  break;
              }
              // 处理其它数据
              logoutPushMsg( msg );
          }, false );

          // 监听在线消息事件
          plus.push.addEventListener( "receive", function( msg ) {

              localStorage.refresh = 1;
              if(typeof(localStorage.token) == 'undefined'){return false;}
              // alert(JSON.stringify(msg));
              var time = getNowTime();
              var payload = JSON.parse(msg.payload);
              // alert(payload)
              var str = '';
              if(objvue.$store.state.listtype == true){
                for(var item in payload){
                  str += payload[item]+',';
                }
                // alert(str);
                // alert(delfh(str))
                siod(delfh(str));
              }

              // alert(parseInt(payload.time) - time);
              // alert(JSON.stringify(messageList));
              // if(parseInt(payload.time) - time < 86400){
                // 把监听到的消息添加数组
                // messageList.push(payload);
                // 排队只有队伍执行完了，才再次调用排队函数
              //   if(messageList.length == 1){
              //     queue(messageList);
              //   }
              // }
          }, false );
        }, false );
      // 获取当天凌晨时间戳
      function getNowTime(){
        var start=new Date();
        start.setHours(0);
        start.setMinutes(0);
        start.setSeconds(0);
        start.setMilliseconds(0);
        var todayStartTime = Date.parse(start)/1000;
        return todayStartTime;
      }
   /*   setTimeout(function(){
        str = '5393'
        console.dir(444)
      siod(delfh(str));
    },3000)*/

      function in_array(search,array){
          for(var i in array){
              if(array[i].id==search){
                  return true;
              }
          }
          return false;
      }

       function distinct(arra){//字符串转数组去重转字符串

          var arr = arra.split(',');
          var result = [],
          i,
          j,
          set
          len = arr.length;
          for(i = 0; i < len; i++){
            for(j = i + 1; j < len; j++){
             if(arr[i] === arr[j]){
              j = ++i;
             }
            }
            result.push(arr[i]);
          }
          for(var item in result){
            set += result[item]+',';
          }

         return delfh(set);
      }

      function siod(payload){

        objvue.$store.state.orderlistid = delfh(payload);
        objvue.$store._actions.orderlist[0]()

      }

      function delfh(str){
        str=str.replace(",,",",");
        if(str.substring(str.length-1,str.length)==","){
        str2=str.substring(0,str.length-1);
        delfh(str2);
        }else{
        str2=str;
        }
        return str2;
      }


      //消息播报
      function broadcast(){
        // plus.push.createMessage('您有'+objvue.$store.state.orderlistid == '' ? 0 : objvue.$store.state.orderlistid.split(",").length+'条新订单请尽快处理','LocalMSG',{"title":'收到新订单',"sound":"none","cover":false});
        plus.push.createMessage('  您有新订单请及时处理','LocalMSG',{"title":'收到新订单',"sound":"none","cover":false});

        // 如果设置了响铃，就apend一个audio到id为app的标签里
        // if(reponse['sound'] == 't' ){
          // createAudio(reponse['url'],reponse['table_id']);
          createSpeech();
        // }
      }


      // 消息进行排队设置
      function queue(messageList){
        if(messageList.length > 0 ){
          // var id = '';
          // for(item in messageList){
          //   id += messageList[item['id']];
          // }

          var reponse = messageList[0];
          // 创建消息
          plus.push.createMessage(reponse['content'],'LocalMSG',{"title":reponse['title'],"sound":"none","cover":false});
          // 如果设置了响铃，就apend一个audio到id为app的标签里
          if(reponse['sound'] == 't' ){
            // createAudio(reponse['url'],reponse['table_id']);
            // createSpeech(reponse);
          }
          // 延迟8秒后，再播放下一条通知
          setTimeout(function(){
            messageList.splice(0,1);
            queue(messageList);
          },10000);
        }
      }
      // 创建audio标签
      function createAudio(url,table_id) {
        var audio = document.createElement('audio');
        var app = document.getElementById('app');
        var oldAudio = document.getElementById(table_id.toString());
        // 如果已经存在这个id，就先移除掉
        if(oldAudio){
          app.removeChild(oldAudio);
        }
        audio.setAttribute('controls','controls');
        audio.setAttribute('autoplay','autoplay');
        audio.setAttribute('src',url);
        audio.setAttribute('id',table_id.toString());
        // audio.setAttribute('loop','loop');
        audio.style.display = 'none';
        app.appendChild(audio);
      }
      // 使用科大讯飞
      function createSpeech(reponse) {
        var str = {};
        // if(reponse['type'] == 1){
        //   str = reponse['tablename'] + '有新的扫码点餐订单，' + reponse['tablename'] + '有新的扫码点餐订单';
        // }else if(reponse['type'] == 4){
        //   str = reponse['tablename'] + '有新的预点餐订单，' + reponse['tablename'] + '有新的预点餐订单';
        // }else if(reponse['type'] == 2){
        //   str = reponse['tablename'] + '有新的外卖订单' + reponse['tablename'] + '有新的外卖订单';
        // }else if(reponse['type'] == 3){
        //   str = reponse['tablename'] + '请用餐，' + reponse['tablename'] + '请用餐';
        // }
        // str = '     您有'+objvue.$store.state.orderlistid == '' ? 0 : objvue.$store.state.orderlistid.split(",").length+'条新订单请尽快处理';
        str = '     您有新订单请及时处理';

        objvue.$store.state.orderlistid = '';
        switch ( plus.os.name ) {
          case "Android":
            var main = plus.android.runtimeMainActivity();
            var SpeechUtility = plus.android.importClass('com.iflytek.cloud.SpeechUtility');
            var SpeechConstant = plus.android.importClass('com.iflytek.cloud.SpeechConstant');
            SpeechUtility.createUtility(main,"appid=5af2af41");
            var SynthesizerPlayer = plus.android.importClass('com.iflytek.cloud.SpeechSynthesizer');
            var play = SynthesizerPlayer.createSynthesizer(main, null);
            play.setParameter(SpeechConstant.VOICE_NAME, "xiaojing");//设置发音人
            play.setParameter(SpeechConstant.SPEED, "10");//设置语速
            play.setParameter(SpeechConstant.VOLUME, "90");//设置音量，范围0~100
            // play.setParameter(SpeechConstant.ENGINE_TYPE, SpeechConstant.TYPE_CLOUD); //设置云端
            play.startSpeaking(str,null);
          break;
          case "iOS":
            var AVSpeechSynthesizer = plus.ios.importClass("AVSpeechSynthesizer");
            var AVSpeechUtterance = plus.ios.importClass("AVSpeechUtterance");
            var AVSpeechSynthesisVoice = plus.ios.import("AVSpeechSynthesisVoice");
            var sppech = new AVSpeechSynthesizer();
            var voice = AVSpeechSynthesisVoice.voiceWithLanguage("zh-CN");
            var utterance =  AVSpeechUtterance.speechUtteranceWithString(str);
               // utterance.plusSetAttribute("rate",30.1);
            utterance.setVoice(voice);
            sppech.speakUtterance(utterance);
          break;
          default:
          // 其它平台
          break;
        }
      }

    function addZero(time){
      if (time <= 9) {
          time = "0" + time;
      }
      return time;
    }

    function getNowFormatDate(item){
      var date = new Date();
      var seperator1 = "-";
      var year = date.getFullYear();
      var month = date.getMonth() + 1;
      var strDate = date.getDate();
      var hour = date.getHours();
      var min = date.getMinutes();
      // this.sce = date.getSeconds();
      month = this.addZero(month);
      strDate = this.addZero(strDate);
      hour = this.addZero(hour);
      min = this.addZero(min);
      var currentdate = year + seperator1 + month + seperator1 + strDate + " " + hour + ":" + min;
      if(typeof(item) != 'undefined' && item.res == 'data'){
        currentdate = year + seperator1 + month + seperator1 + strDate;
      }
      return currentdate;
    }</script></html>